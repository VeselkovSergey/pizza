<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>

<!--<link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css"/>-->

<!--<script src="https://cdn.plyr.io/3.7.2/plyr.polyfilled.js"></script>-->

<script src="https://player.svetacdn.in/storage/default_players/s_v120.js"></script>
<link rel="stylesheet" href="https://player.svetacdn.in/iframe.css">


<style>
    .film-card-container {
        max-width: 200px;
        padding: 10px;
    }

    .film-card-container img {
        border-radius: 10px;
    }
</style>

<div style="padding: 20px;">

    <div style="padding: 10px 0;">
        <input style="padding: 10px 20px; width: 100%;" type="text" placeholder="Название фильма" class="search-field">
    </div>

    <div class="videos-cards-container" style="display: flex; flex-wrap: wrap;">


    </div>

    <div class="serials-cards-container" style="display: flex; flex-wrap: wrap;">


    </div>

    <div class="film-info-container">


    </div>

    <div style="max-height: 100vh; max-width: 100vw; height: 400px; width: 700px;">
        <div id="iframe" style="position: relative; width: 100%; height: 100%;"></div>
    </div>

    <div class="film-translations" style="display: flex; flex-wrap: wrap;">


    </div>

    <div class="film-seasons" style="display: flex; flex-wrap: wrap;">


    </div>

    <div class="film-series" style="display: flex; flex-wrap: wrap;">


    </div>


</div>


<div class="player-container" style="width: 50%;">

</div>

<script>

    const videosCardsContainer = document.body.querySelector('.videos-cards-container');
    const serialsCardsContainer = document.body.querySelector('.serials-cards-container');
    const filmTranslations = document.body.querySelector('.film-translations');
    const filmSeasons = document.body.querySelector('.film-seasons');
    const filmSeries = document.body.querySelector('.film-series');
    const filmInfoContainer = document.body.querySelector('.film-info-container');

    function clearFilmsContainer() {
        videosCardsContainer.innerHTML = '';
    }
    function clearSerialsContainer() {
        serialsCardsContainer.innerHTML = '';
    }
    function clearFilmTranslations() {
        filmTranslations.innerHTML = '';
    }
    function clearFilmSeasons() {
        filmSeasons.innerHTML = '';
    }
    function clearFilmSeries() {
        filmSeries.innerHTML = '';
    }
    function clearFilmInfoContainer() {
        filmInfoContainer.innerHTML = '';
    }

    let timerSearchField = null;
    document.body.querySelector('.search-field').addEventListener('keydown', (event) => {


        if (event.target.value.length === 0) {
            clearFilmsContainer();
            clearSerialsContainer();
            clearFilmTranslations();
            clearFilmSeasons();
            clearFilmSeries();
            clearFilmInfoContainer();
        }

        if (event.target.value.length < 3) return;

        let query = event.target.value;

        if (event.key === 'Enter') {
            keydownSearchInput(query)
        }

    });

    document.body.querySelector('.search-field').addEventListener('input', (event) => {

        if (event.target.value.length < 3) return;

        let query = event.target.value;

        clearTimeout(timerSearchField);

        timerSearchField = setTimeout(() => keydownSearchInput(query), 1000);

    });

    function keydownSearchInput(query) {
        clearFilmsContainer();
        clearSerialsContainer();
        clearFilmTranslations();
        clearFilmSeasons();
        clearFilmSeries();
        clearFilmInfoContainer();
        document.getElementById('iframe').innerHTML = '';
        window.history.pushState(null, null, '?film=' + query);

        searchFilms(query);
        searchSerials(query);
    }

    function searchFilms(query) {
        const SEARCH_API_URL = 'https://apitmdb.cub.watch/3/search/movie?api_key=4ef0d7355d9ffb5151e987764708ce96&language=ru&query=';

        fetch(SEARCH_API_URL + query)
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                generateFilmsCards(data.results, videosCardsContainer);
            });
    }

    function searchSerials(query) {
        const SEARCH_API_URL = 'https://apitmdb.cub.watch/3/search/tv?api_key=4ef0d7355d9ffb5151e987764708ce96&language=ru&query=';

        fetch(SEARCH_API_URL + query)
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                generateFilmsCards(data.results, serialsCardsContainer, true);
            });
    }

    const FILM_POSTER_URL = 'https://imagetmdb.cub.watch/t/p/w200';

    function generateFilmsCards(filmsObjects, container, isSerial = false) {

        if (Object.keys(filmsObjects).length > 0) {
            const titleCategory = document.createElement('h3');
            titleCategory.style.width = '100%'
            titleCategory.innerHTML = isSerial ? 'Сериалы' : 'Фильмы';
            container.append(titleCategory);
        }

        filmsObjects
            .sort((prev, next) => {
                let prevDate = prev.release_date ?? prev.first_air_date;
                let nextDate = next.release_date ?? next.first_air_date;

                return Date.parse(nextDate) - Date.parse(prevDate);
            })
            .forEach((filmObject) => {
            const id = filmObject.id;
            const title = filmObject.title ?? filmObject.name;
            const description = filmObject.overview;
            const poster = filmObject.poster_path !== null ? FILM_POSTER_URL + filmObject.poster_path : 'https://bpic.588ku.com/back_pic/05/10/88/62598e75d484d19.jpg!/fh/300/quality/90/unsharp/true/compress/true';
            const releaseDate = filmObject.release_date ?? filmObject.first_air_date;

            const filmContainer = document.createElement('div');
            filmContainer.addEventListener('click', () => getFilmInfo(id, isSerial))
            filmContainer.className = 'film-card-container';
            container.append(filmContainer);

            const posterContainer = document.createElement('img');
            posterContainer.src = poster;
            filmContainer.append(posterContainer);

            const titleContainer = document.createElement('div');
            titleContainer.innerHTML = title
            filmContainer.append(titleContainer);

            const releaseDateContainer = document.createElement('div');
            releaseDateContainer.innerHTML = releaseDate
            filmContainer.append(releaseDateContainer);
        });
    }

    function getFilmInfo(id, isSerial) {
        const FILM_URL = 'https://apitmdb.cub.watch/3/'+(isSerial ? 'tv' : 'movie')+'/' + id + '?api_key=4ef0d7355d9ffb5151e987764708ce96&language=ru'
        fetch(FILM_URL)
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                showFilmInfo(data, isSerial);
            });
    }

    function showFilmInfo(filmInfo, isSerial) {
        clearFilmsContainer();
        clearFilmInfoContainer();
        clearSerialsContainer();

        const id = filmInfo.id;
        // const imdbId = filmInfo.imdb_id;
        const title = filmInfo.title ?? filmInfo.name;
        const description = filmInfo.overview;
        const poster = FILM_POSTER_URL + filmInfo.poster_path;
        const releaseDate = filmInfo.release_date ?? filmInfo.first_air_date;


        const filmContainer = document.createElement('div');
        filmInfoContainer.append(filmContainer);

        const posterContainer = document.createElement('img');
        posterContainer.src = poster;
        filmContainer.append(posterContainer);

        const startViewing = document.createElement('button');
        startViewing.innerHTML = 'Просмотр';
        startViewing.addEventListener('click', () => {
            fetch('https://apitmdb.cub.watch/3/'+(isSerial ? 'tv' : 'movie')+'/'+id+'/external_ids?api_key=4ef0d7355d9ffb5151e987764708ce96&language=ru')
                .then((response) => {
                    return response.json();
                })
                .then((data) => {
                    getFilmFiles(data.imdb_id, isSerial, title);
                });

        });
        filmContainer.append(startViewing);

        const titleContainer = document.createElement('div');
        titleContainer.innerHTML = title
        filmContainer.append(titleContainer);

        const releaseDateContainer = document.createElement('div');
        releaseDateContainer.innerHTML = releaseDate
        filmContainer.append(releaseDateContainer);

        const descriptionContainer = document.createElement('div');
        descriptionContainer.innerHTML = description
        filmContainer.append(descriptionContainer);

    }

    function getFilmFiles(imdbId, isSerial, title) {
        fetch('https://cdn.svetacdn.in/api/'+(isSerial ? 'tv-series' : 'short')+'?api_token=' + VIDEO_CDN_API_TOKEN + (imdbId ? ('&imdb_id=' + imdbId) : ('&title=' + title)))
            .then((response) => {
                return response.json();
            })
            .then((data) => {

                if (data?.data[0]?.iframe_src) {
                    parseVideoFiles(data.data[0]);
                    clearFilmsContainer();
                    clearFilmInfoContainer();
                    clearSerialsContainer();
                } else {
                    alert('Нет данных');
                }
            });
    }

    const VIDEO_CDN_API_TOKEN = '3i40G5TSECmLF77oAqnEgbx61ZWaOYaE';

    let translations = {};

    function parseVideoFiles(data) {

        const iframeSrc = data.iframe_src;

        translations = {};

        data.translations.forEach((translation) => {
            if (!translation.id) return;
            translations[translation.id] = {
                translationTitle: translation.title,
            }
        });

        fetch('https:'+iframeSrc+'?api_token=' + VIDEO_CDN_API_TOKEN)
            .then((response) => {
                response.text()
                    .then((raw) => {


                        let newIframe = raw.replace(/\n/g, '').replace('/iframe.js', './videocdn.js');
                        let math1 = newIframe.match(/<body[^>]+>(.*)<\/body>/);

                        document.getElementById('iframe').innerHTML = math1[1];

                        document.body.querySelectorAll('#videocdn_js').forEach((el) => el.remove());
                        let myScript = document.createElement('script');
                        myScript.src = './videocdn.js'
                        myScript.id = 'videocdn_js'
                        document.body.append(myScript);


                        return;

                        /**
                         * для своего плеера
                         */
                        if (Object.keys(translations).length === 0) {
                            let regExp = new RegExp('<option[^>]+value="(.*?)"[^>]+>(.*?)<\\/option>', 'gms');
                            let translationsMathAll = raw.replace(/\n/g, '').matchAll(regExp);
                            translationsMathAll = Array.from(translationsMathAll);

                            translationsMathAll.forEach((translation) => {
                                translations[translation[1]] = {
                                    translationTitle: translation[2].trim()
                                }
                            });
                        }

                        let math = raw.replace(/\n/g, '').match(/id="files" value="(.*?)"/);

                        let json = JSON.parse(math[1].replace(/&quot;/g, '"'));

                        Object.keys(json).forEach((index) => {

                            const translationRaw = json[index];

                            if (!translations[index]) {
                                return;
                            }

                            try {
                                translations[index]['seasons'] = JSON.parse(translationRaw);
                            }catch (e) {
                                translations[index]['qualities'] = extractItems(translationRaw, 0);
                            }
                        });

                        generateTranslates();

                    });
            });

        function extractItems(str) {
            try {
                let items = str.split(',').map(function (item) {
                    return {
                        quality: parseInt(item.match(/\[(\d+)p\]/)[1]),
                        file: 'http:' + item.replace(/\[\d+p\]/, '').split(' or ')[0]
                    };
                })/*.filter(function (item) {
                return item.quality <= max_quality;
            });*/
                items.sort(function (a, b) {
                    return b.quality - a.quality;
                });
                return items;
            } catch (e) {
            }

            return [];
        }

        function generateTranslates() {

            clearFilmTranslations();
            clearFilmSeasons();
            clearFilmSeries();

            Object.keys(translations).forEach((translateId) => {
                const translation = translations[translateId];
                const translationItem = document.createElement('button');
                translationItem.innerHTML = translation.translationTitle;
                filmTranslations.append(translationItem);

                translationItem.addEventListener('click', () => setTranslate(translation));

            });

            function setTranslate(translation) {

                clearFilmSeasons();

                if (translation.qualities) {    // для сингл
                    const plyrVideoData = [];
                    translation.qualities.forEach((item) => {
                        plyrVideoData.push({
                            src: item.file,
                            type: 'video/mp4',
                            size: item.quality,
                        });
                    });

                    startPlayer(plyrVideoData)

                } else {
                    translation.seasons.forEach((season) => {
                        const seasonContainer = document.createElement('button');
                        seasonContainer.innerHTML = season.comment.replace('&lt;br&gt;', '').replace('&lt;i&gt;', ' ').replace('&lt;/i&gt;', '');
                        filmSeasons.append(seasonContainer);
                        seasonContainer.addEventListener('click', () => {

                            clearFilmSeries();

                            if (!season.folder) {   // для без сезонных

                                let qualities = extractItems(season.file, 0);

                                const plyrVideoData = [];
                                qualities.forEach((item) => {
                                    plyrVideoData.push({
                                        src: item.file,
                                        type: 'video/mp4',
                                        size: item.quality,
                                    });
                                });

                                startPlayer(plyrVideoData)

                            } else {    // с сезонами

                                season.folder.forEach((series) => {
                                    const seriesContainer = document.createElement('button');
                                    seriesContainer.innerHTML = series.comment.replace('&lt;br&gt;', '').replace('&lt;i&gt;', ' ').replace('&lt;/i&gt;', '');
                                    filmSeries.append(seriesContainer);

                                    seriesContainer.addEventListener('click', () => {
                                        let qualities = extractItems(series.file, 0);

                                        const plyrVideoData = [];
                                        qualities.forEach((item) => {
                                            plyrVideoData.push({
                                                src: item.file,
                                                type: 'video/mp4',
                                                size: item.quality,
                                            });
                                        });

                                        startPlayer(plyrVideoData)
                                    });

                                });
                            }
                        });
                    });
                }

            }

            function startPlayer(plyrVideoData) {
                const playerContainer = document.body.querySelector('.player-container');
                playerContainer.innerHTML = '<video id="player" crossorigin="anonymous"></video>';

                const player = new Plyr('#player');
                player.source = {
                    type: 'video',
                    title: 'Example title',
                    download: false,
                    sources: plyrVideoData,
                };
            }

        }

    }

    const url = new URL(location.href);
    const filmTitle = url.searchParams.get("film");
    const isCard = url.searchParams.get("card");

    if (filmTitle) {
        document.body.querySelector('.search-field').value = filmTitle;
        keydownSearchInput(filmTitle);
    }

</script>

</body>
</html>
